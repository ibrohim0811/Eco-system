{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoLife Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0d0221; --card:#160a2f; --muted:#a7a7b3;
      --neon-blue:#00d4ff; --neon-purple:#9d50bb; --neon-green:#00ff88; --neon-red:#ff4d6d;
      --border:rgba(255,255,255,0.08);
      --shadow:0 10px 35px rgba(0,0,0,0.35);
    }
    *{ box-sizing:border-box; }
    body{
      background: radial-gradient(1200px 600px at 10% 0%, rgba(0,212,255,0.08), transparent 55%),
                  radial-gradient(900px 500px at 90% 20%, rgba(157,80,187,0.08), transparent 55%),
                  var(--bg);
      color:#fff;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      margin:20px;
    }
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;}
    .title{display:flex;flex-direction:column;gap:4px;}
    .title h2{margin:0;color:var(--neon-blue);font-weight:800;letter-spacing:.3px;}
    .subtitle{color:var(--muted);font-size:13px;}
    .pill{
      padding:10px 14px;border:1px solid var(--border);border-radius:999px;
      background:rgba(255,255,255,0.04);box-shadow:var(--shadow);
      font-size:13px;color:#eaeaf2;display:flex;align-items:center;gap:10px;white-space:nowrap;
    }
    .pill b{color:var(--neon-green);}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;margin-bottom:18px;}
    .card{
      background:rgba(255,255,255,0.03);border:1px solid var(--border);
      border-radius:18px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(10px);
    }
    .stat{display:flex;flex-direction:column;gap:10px;min-height:132px;}
    .stat h1{margin:0;font-size:34px;line-height:1;}
    .stat p{margin:0;color:var(--muted);font-size:13px;}
    .progress{height:10px;background:#25104a;border-radius:999px;overflow:hidden;}
    .progress>div{height:100%;border-radius:999px;transition:width .9s ease;}
    .span-3{grid-column:span 3;} .span-4{grid-column:span 4;}
    .span-6{grid-column:span 6;} .span-8{grid-column:span 8;}
    .span-12{grid-column:span 12;}
    .chart-box{min-height:320px;}
    canvas{width:100% !important;height:260px !important;}
    .mini-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .mini-title h3,.mini-title h4{margin:0;}
    .mini-title small{color:var(--muted);}
    .muted{color:var(--muted);}

    /* Calendar */
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px;color:#dcdcf0;}
    .dow{color:var(--muted);text-align:center;padding:6px 0;}
    .day{
      text-align:center;padding:8px 0;border-radius:10px;background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
    }
    .day.active{
      border-color:rgba(0,255,136,0.45);color:var(--neon-green);font-weight:800;background:rgba(0,255,136,0.06);
    }
    .day.muted{opacity:.35;}

    /* Table */
    .table{width:100%;border-collapse:collapse;margin-top:6px;font-size:14px;}
    .table th{
      color:var(--muted);font-weight:600;text-align:left;padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);font-size:13px;
    }
    .table td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,0.06);vertical-align:middle;}

    .badge{
      padding:6px 12px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,0.12);
      display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .b-pending{background:rgba(243,156,18,0.12);color:#f39c12;border-color:rgba(243,156,18,0.25);}
    .b-accepted{background:rgba(46,204,113,0.12);color:#2ecc71;border-color:rgba(46,204,113,0.25);}
    .b-rejected{background:rgba(255,77,109,0.12);color:var(--neon-red);border-color:rgba(255,77,109,0.25);}

    @media (max-width: 1100px){
      .span-3,.span-4,.span-6,.span-8{grid-column:span 12;}
      canvas{height:240px !important;}
    }
    a{
        text-decoration: none;
        color: aqua ;
    }
    .tit{
        display: flex;
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="title">
       <div class="tit">
        <a href="{% url 'main' %}"><h2>üåø EcoLife </a><h2>/ Shaxsiy Kabinet</h2>
       </div>
      <div class="subtitle">Faollik, ballar va oxirgi harakatlar statistikasi</div>
    </div>

    <div class="pill">
      üèÖ Badge: <b>{{ request.user.badge|default:"üå± Eco Boshlovchi" }}</b> ¬∑
      üí∞ Balans: <b>{{ balance|default:0 }}</b> so‚Äòm
    </div>
  </div>

  <!-- Top stats -->
  <div class="grid">
    <div class="card stat span-3">
      <h1 style="color: var(--neon-green);">{{ total_amount }}</h1>
      <p>Umumiy ballar</p>
      <div class="progress"><div style="width: {{ total_progress|default:0 }}%; background: var(--neon-green);"></div></div>
      <small class="muted">Maqsadga yaqinlashuv: {{ total_progress|default:0 }}%</small>
    </div>

    <div class="card stat span-3">
      <h1 style="color: var(--neon-blue);">{{ accepted_count }}</h1>
      <p>Tasdiqlangan</p>
      <div class="progress"><div style="width: {{ accepted_progress|default:0 }}%; background: var(--neon-blue);"></div></div>
      <small class="muted">Tasdiqlanish ulushi: {{ accepted_progress|default:0 }}%</small>
    </div>

    <div class="card stat span-3">
      <h1 style="color: var(--neon-purple);">{{ pending_count }}</h1>
      <p>Kutilmoqda</p>
      <div class="progress"><div style="width: {{ pending_progress|default:0 }}%; background: var(--neon-purple);"></div></div>
      <small class="muted">Jarayonda: {{ pending_progress|default:0 }}%</small>
    </div>

    <div class="card stat span-3">
      <div class="mini-title">
        <h4>Haftalik maqsad</h4>
        <small>{{ weekly_progress|default:0 }}%</small>
      </div>
      <div class="progress">
        <div style="width: {{ weekly_progress|default:0 }}%; background: linear-gradient(90deg, #9d50bb, #00d4ff);"></div>
      </div>
      <small class="muted">Haftada bajarilishi kerak bo‚Äòlgan reja</small>
    </div>
  </div>

  <!-- Multi charts row 1 -->
  <div class="grid">
    <div class="card chart-box span-8">
      <div class="mini-title">
        <h3>üìà 14 kunlik dinamika (Accepted)</h3>
        <small>kunlar bo‚Äòyicha</small>
      </div>
      <canvas id="dailyChart"></canvas>
    </div>

    <div class="card span-4">
      <div class="mini-title">
        <h3>üç© Status ulushi</h3>
        <small>accepted / pending / rejected</small>
      </div>
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Multi charts row 2 -->
  <div class="grid">
    <div class="card span-6">
      <div class="mini-title">
        <h3>üèô Hududlar bo‚Äòyicha</h3>
        <small>top 6</small>
      </div>
      <canvas id="regionChart"></canvas>
    </div>

    <div class="card span-6">
      <div class="mini-title">
        <h3>üìÜ Haftalik faollik</h3>
        <small>so‚Äònggi 7 kun</small>
      </div>
      <canvas id="weekChart"></canvas>
    </div>
  </div>

  <!-- Eco profile radar + calendar -->
  <div class="grid">
    <div class="card span-8">
      <div class="mini-title">
        <h3>üß≠ Eco profil (Radar)</h3>
        <small>baholash profili</small>
      </div>
      <canvas id="radarChart"></canvas>
    </div>

    <div class="card span-4">
      <div class="mini-title">
        <h4 id="month-name">{{ month_name|default:"Yanvar" }}</h4>
        <small>{{ year|default:"2026" }}</small>
      </div>

      <div class="calendar">
        <div class="dow">D</div><div class="dow">S</div><div class="dow">Ch</div><div class="dow">P</div><div class="dow">J</div><div class="dow">Sh</div><div class="dow">Y</div>
        {% for d in calendar_days %}
          <div class="day {% if d == today_day %}active{% endif %} {% if d == 0 %}muted{% endif %}">
            {% if d == 0 %}&nbsp;{% else %}{{ d }}{% endif %}
          </div>
        {% endfor %}
      </div>

      <div style="margin-top:14px; font-size:12px;" class="muted">
        ‚úÖ Bugun ajratilgan kun yashil bilan belgilanadi.
      </div>
    </div>
  </div>

  <!-- Activities -->
  <div class="card span-12">
    <div class="mini-title">
      <h3>üßæ Oxirgi harakatlar</h3>
      <small>So‚Äònggi {{ activities|length }} ta yozuv</small>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Sana</th>
          <th>Hudud</th>
          <th>Ball</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for act in activities %}
        <tr>
          <td>{{ act.created_at|date:"d.m.Y" }}</td>
          <td>{{ act.region }}</td>
          <td style="color: var(--neon-green); font-weight:700;">+{{ act.amount|default:0 }}</td>
          <td>
            {% if act.status == "pending" %}
              <span class="badge b-pending">‚è≥ Kutilmoqda</span>
            {% elif act.status == "accepted" %}
              <span class="badge b-accepted">‚úÖ Qabul qilindi</span>
            {% else %}
              <span class="badge b-rejected">‚ùå Rad etildi</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center; padding:22px;" class="muted">Ma'lumot topilmadi</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // ‚úÖ json_script YO‚ÄòQ. Faqat json.dumps + |safe
    const dailyLabels = {{ daily_labels|safe }};
    const dailyValues = {{ daily_values|safe }};

    const statusLabels = {{ status_labels|safe }};
    const statusValues = {{ status_values|safe }};

    const regionLabels = {{ region_labels|safe }};
    const regionValues = {{ region_values|safe }};

    const weekLabels = {{ week_labels|safe }};
    const weekValues = {{ week_values|safe }};

    const radarLabels = {{ radar_labels|safe }};
    const radarValues = {{ radar_values|safe }};

    // 1) Line
    new Chart(document.getElementById('dailyChart'), {
      type: 'line',
      data: { labels: dailyLabels, datasets: [{
        data: dailyValues,
        borderColor: '#00d4ff',
        backgroundColor: 'rgba(0, 212, 255, 0.12)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 4,
        pointBackgroundColor: '#9d50bb'
      }]},
      options: { plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: 'rgba(37,16,74,0.8)' }, ticks: { color: '#a7a7b3' } },
          x: { grid: { display: false }, ticks: { color: '#a7a7b3' } }
        }
      }
    });

    // 2) Doughnut
    new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: { labels: statusLabels, datasets: [{
        data: statusValues,
        backgroundColor: [
          'rgba(0,255,136,0.9)',
          'rgba(157,80,187,0.9)',
          'rgba(255,77,109,0.9)'
        ],
        borderWidth: 0
      }]},
      options: { cutout: '72%', plugins:{ legend:{ labels:{ color:'#bbb' }}} }
    });

    // 3) Region bar
    new Chart(document.getElementById('regionChart'), {
      type: 'bar',
      data: { labels: regionLabels, datasets: [{
        data: regionValues,
        backgroundColor: 'rgba(0,255,136,0.55)',
        borderRadius: 10
      }]},
      options: { plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: 'rgba(37,16,74,0.8)' }, ticks: { color: '#a7a7b3' } },
          x: { grid: { display: false }, ticks: { color: '#a7a7b3' } }
        }
      }
    });

    // 4) Week bar
    new Chart(document.getElementById('weekChart'), {
      type: 'bar',
      data: { labels: weekLabels, datasets: [{
        data: weekValues,
        backgroundColor: 'rgba(0,212,255,0.55)',
        borderRadius: 10
      }]},
      options: { plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: 'rgba(37,16,74,0.8)' }, ticks: { color: '#a7a7b3' } },
          x: { grid: { display: false }, ticks: { color: '#a7a7b3' } }
        }
      }
    });

    // 5) Radar
    new Chart(document.getElementById('radarChart'), {
      type: 'radar',
      data: { labels: radarLabels, datasets: [{
        data: radarValues,
        backgroundColor: 'rgba(157,80,187,0.22)',
        borderColor: '#9d50bb',
        pointBackgroundColor: '#00d4ff',
        borderWidth: 2
      }]},
      options: { plugins: { legend: { display: false } },
        scales: {
          r: {
            angleLines: { color: 'rgba(255,255,255,0.08)' },
            grid: { color: 'rgba(255,255,255,0.08)' },
            pointLabels: { color: '#bbb' },
            ticks: { display: false }
          }
        }
      }
    });
  </script>
</body>
</html>
